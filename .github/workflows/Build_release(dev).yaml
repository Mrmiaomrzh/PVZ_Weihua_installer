name: Build PVZ Weihua Installer

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 1.0.0)'
        required: true
        default: '1.0.0'
      pre_install_text:
        description: 'Update Log (IBF): Enter your update notes here.'
        required: false
        type: string
      post_install_text:
        description: 'Post-install text (IAF): Optional.'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. 预处理：生成带中文的模板文件，避开 YAML 解析
      - name: Prepare Template Files
        shell: powershell
        run: |
          # 定义固定补充说明 (保存为临时文件，避免在脚本中直接写中文)
          $Footer = @"

          补充说明:
           在游戏过程中,如果遇到窗口白屏情况,请退出游戏后打开游戏存储目录,
           依次进入[修复和扩展文件]文件夹-[修复]文件夹,运行[【运行后打开游戏】窗口白屏卡死.reg]文件,
           运行后重新启动游戏即可。
           
           遇到Bug可进入 威化版公测组 反馈~
          "@
          $Footer | Out-File -FilePath "footer.tmp" -Encoding utf8
          
          $Prefix = "版本更新内容:"
          $Prefix | Out-File -FilePath "prefix.tmp" -Encoding utf8

      # 2. 处理文本文件 (IBF.txt 和 IAF.txt)
      - name: Process Text Files
        shell: powershell
        run: |
          $Ver = "${{ inputs.version }}"
          $InputPre = "${{ inputs.pre_install_text }}"
          $InputPost = "${{ inputs.post_install_text }}"

          if (!(Test-Path "Setup")) { New-Item -ItemType Directory -Path "Setup" }

          # 处理 IBF.txt (安装前)
          if ($InputPre -and $InputPre.Trim() -ne "") {
              $PrefixStr = Get-Content "prefix.tmp" -Raw
              $FooterStr = Get-Content "footer.tmp" -Raw
              $FinalIBF = $PrefixStr + "`r`n" + $InputPre + "`r`n" + $FooterStr
              $FinalIBF | Out-File -FilePath "Setup/IBF.txt" -Encoding utf8
              $InputPre | Out-File -FilePath "release_notes.txt" -Encoding utf8
          } else {
              Copy-Item "src/IPT/IBF.txt" -Destination "Setup/IBF.txt" -Force
              "PVZ Weihua $Ver" | Out-File -FilePath "release_notes.txt" -Encoding utf8
          }

          # 处理 IAF.txt (安装后)
          if ($InputPost -and $InputPost.Trim() -ne "") {
              $InputPost | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8
          } else {
              Copy-Item "src/IPT/IAF.txt" -Destination "Setup/IAF.txt" -Force
          }

      # 3. 处理 ISS 脚本变量替换
      - name: Prepare ISS Script
        shell: powershell
        run: |
          $Ver = "${{ inputs.version }}"
          # 读取 src/Main.iss 
          $Content = Get-Content -Path "src/Main.iss" -Raw -Encoding utf8
          
          # 正则替换 MyAppVerNum 和 MyAppVerFull 
          $Content = $Content -replace '(#define\s+MyAppVerNum\s+")[^"]*(")', "`${1}$Ver`${2}"
          $Content = $Content -replace '(#define\s+MyAppVerFull\s+")[^"]*(")', "`${1}$Ver`${2}"
          
          # 写入 Setup/PVZ_Weihua.iss 
          [System.IO.File]::WriteAllText("Setup/PVZ_Weihua.iss", $Content, [System.Text.Encoding]::UTF8)

      # 4. 执行 Inno Setup 编译
      - name: Compile Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: Setup/PVZ_Weihua.iss

      # 5. 发布 Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: PVZ Weihua v${{ inputs.version }}
          body_path: release_notes.txt
          files: Output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}