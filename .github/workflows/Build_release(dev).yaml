name: Build PVZ Weihua Installer

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 1.0.0)'
        required: true
        default: '1.0.0'
      pre_install_text:
        description: 'Update Log (IBF): Will add prefix and suffix automatically.'
        required: false
        type: string
      post_install_text:
        description: 'Post-install text (IAF): Optional.'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Process Text Files
      - name: Process Text Files
        shell: powershell
        run: |
          $Ver = "${{ inputs.version }}"
          $InputPre = "${{ inputs.pre_install_text }}"
          $InputPost = "${{ inputs.post_install_text }}"
          
          # Use a basic string to avoid ParserError
          $Footer = "`r`n`r`n补充说明:`r`n 在游戏过程中,如果遇到窗口白屏情况,请退出游戏后打开游戏存储目录,`r`n 依次进入[修复和扩展文件]文件夹-[修复]文件夹,运行[【运行后打开游戏】窗口白屏卡死.reg]文件,`r`n 运行后重新启动游戏即可。`r`n `r`n 遇到Bug可进入 威化版公测组 反馈~"

          if (!(Test-Path "Setup")) { New-Item -ItemType Directory -Path "Setup" }

          # Pre-install text logic
          if ($InputPre -and $InputPre.Trim() -ne "") {
              $FinalIBF = "版本更新内容:`r`n" + $InputPre + $Footer
              $FinalIBF | Out-File -FilePath "Setup/IBF.txt" -Encoding utf8
              # Set Release Body
              $InputPre | Out-File -FilePath "release_notes.txt" -Encoding utf8
          } else {
              Copy-Item "src/IPT/IBF.txt" -Destination "Setup/IBF.txt" -Force
              "PVZ Weihua $Ver Release" | Out-File -FilePath "release_notes.txt" -Encoding utf8
          }

          # Post-install text logic
          if ($InputPost -and $InputPost.Trim() -ne "") {
              $InputPost | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8
          } else {
              Copy-Item "src/IPT/IAF.txt" -Destination "Setup/IAF.txt" -Force
          }

      # 2. Prepare ISS Script
      - name: Prepare ISS Script
        shell: powershell
        run: |
          $Ver = "${{ inputs.version }}"
          $Content = Get-Content -Path "src/Main.iss" -Raw
          # Regex replacement for your Main.iss 
          $Content = $Content -replace '(#define\s+MyAppVerNum\s+")[^"]*(")', "`${1}$Ver`${2}"
          $Content = $Content -replace '(#define\s+MyAppVerFull\s+")[^"]*(")', "`${1}$Ver`${2}"
          [System.IO.File]::WriteAllText("Setup/PVZ_Weihua.iss", $Content, [System.Text.Encoding]::UTF8)

      # 3. Compile Installer
      - name: Compile Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: Setup/PVZ_Weihua.iss

      # 4. Create Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: PVZ Weihua v${{ inputs.version }}
          body_path: release_notes.txt
          files: Output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}