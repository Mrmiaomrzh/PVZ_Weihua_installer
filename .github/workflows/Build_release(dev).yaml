name: Build PVZ Weihua Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: '正式版本號 (例如: 0.4.7)'
        required: true
      include_tools:
        description: '是否一同打包遊戲補丁及工具 (src/Tools)?'
        required: true
        type: boolean
        default: false
      pre_install_text:
        description: '安裝前文本 (更新內容)'
        required: false
        type: string
      post_install_text:
        description: '安裝後文本 (注意事項)'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Assets and Script
        shell: powershell
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_INCLUDE_TOOLS: ${{ github.event.inputs.include_tools }}
          INPUT_PRE_TEXT: ${{ github.event.inputs.pre_install_text }}
          INPUT_POST_TEXT: ${{ github.event.inputs.post_install_text }}
        run: |
          # 1. 版本号处理
          $verRaw = $env:INPUT_VERSION
          $digits = ($verRaw -split '[^0-9]+' | Where-Object { $_ -ne "" })
          $verBinary = "$($digits[0..2] -join '.').0"
          if ([string]::IsNullOrEmpty($verBinary) -or $verBinary -eq ".0") { $verBinary = "1.0.0.0" }

          # 2. 目录初始化
          if (!(Test-Path "Output")) { New-Item -ItemType Directory -Path "Output" | Out-Null }
          if (!(Test-Path "Setup")) { New-Item -ItemType Directory -Path "Setup" | Out-Null }

          # 3. 合并工具
          if ($env:INPUT_INCLUDE_TOOLS -eq 'true' -and (Test-Path "src/Tools")) {
              Copy-Item -Path "src/Tools/*" -Destination "Game/" -Recurse -Force
          }

          # 4. 处理文本 (使用 Base64 避免中文乱码破坏脚本结构)
          function Decode-B64 ($b64) {
              return [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($b64))
          }

          $header = Decode-B64 "54mI5pys5pu05paw5YaF5a6577ya" # 版本更新內容：
          $footerTitle = Decode-B64 "6KGl5充6Kqq5piOOg==" # 補充說明:
          $noteLine1 = Decode-B64 "IOWcqOmuOaIsumBjueoizos5aaC5p6c6YGH5Yiw56qX5Y+j55m95bGP5o6D5rG1LOiri+mAnOWHuOmuOaIsumInuaJk+mKaiOmuOaIsumtmOWCqOebruWMmCw="
          $noteLine2 = Decode-B64 "IOWพnemhuOmAsuWFp1vkv67lpI3lkowqOWxlemWuS7tF3mlYfku7blk6otW+kv67lpI3domWuS7tblk6os6YGL6KGMW+OAkOmGLuihjOWพnemTqueonuaIsumAkV3nqqXlj6P55m95bGP5Y2h5q27LnJlZ13mlYfku7Ys"
          $noteLine3 = Decode-B64 "IOmGLuihjOWพnemHjeaWsOWIn+WLlemuOaIsumNs+WPr+OAgg=="
          $bugFeedback = Decode-B64 "IOmYp+WIsEJ1Z+WPr+mAsuWFpSDlqIHljJbniaXlhazmuKzntYQg5Y+N6a6Lfg=="
          $noContent = Decode-B64 "54Sh6KmarOatpOatpOWunOatpOiqqOatpOOAgg=="

          $userContent = $env:INPUT_PRE_TEXT
          if ([string]::IsNullOrWhiteSpace($userContent)) { $userContent = $noContent }

          $lines = @()
          $lines += $header
          $lines += $userContent
          $lines += ""
          $lines += $footerTitle
          $lines += ""
          $lines += $noteLine1
          $lines += $noteLine2
          $lines += $noteLine3
          $lines += ""
          $lines += $bugFeedback

          $finalPreText = $lines -join "`r`n"
          $finalPreText | Out-File -FilePath "Setup/IBF.txt" -Encoding utf8 -Force

          # 5. 处理安装后文本
          $postContent = $env:INPUT_POST_TEXT
          if ([string]::IsNullOrWhiteSpace($postContent)) {
              if (Test-Path "src/IPT/IAF.txt") {
                  Get-Content "src/IPT/IAF.txt" -Raw | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8 -Force
              } else {
                  (Decode-B64 "5a6J6KOX5a6M5oiQ44CC") | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8 -Force
              }
          } else {
              $postContent | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8 -Force
          }

          # 6. 修改 ISS 脚本
          $issSource = "src/Main.iss"
          $issTarget = "Setup/PVZ_Weihua.iss"
          Copy-Item $issSource -Destination $issTarget -Force
          
          $content = Get-Content $issTarget -Raw -Encoding utf8
          $content = $content -replace '(#define\s+MyAppVerNum\s+)"[^"]*"', "`$1""$verRaw"""
          $content = $content -replace '(#define\s+MyAppVerFull\s+)"[^"]*"', "`$1""$verBinary"""
          
          # 修正 ISS 路径引用
          $content = $content -replace 'InfoBeforeFile=.*', 'InfoBeforeFile=IBF.txt'
          $content = $content -replace 'InfoAfterFile=.*', 'InfoAfterFile=IAF.txt'
          $content = $content -replace 'LicenseFile=.*', 'LicenseFile=..\src\IPT\LF.txt'
          $content = $content -replace 'MessagesFile=.*', 'MessagesFile=ChineseSimplified.isl'
          $content = $content -replace 'SetupIconFile=.*', 'SetupIconFile=ico.ico'
          $content = $content -replace 'Source:\s*".*\\{#MyAppExeName}";', 'Source: "..\Game\{#MyAppExeName}";'
          $content = $content -replace 'Source:\s*".*\\\*";', 'Source: "..\Game\*";'
          
          $utf8NoBom = New-Object System.Text.UTF8Encoding($false)
          [System.IO.File]::WriteAllText((Get-Item $issTarget).FullName, $content, $utf8NoBom)

      - name: Compile Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: Setup/PVZ_Weihua.iss

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: PVZ Weihua v${{ github.event.inputs.version }}
          body: ${{ github.event.inputs.pre_install_text || '正式版發布' }}
          files: |
            Output/*.exe
          overwrite_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}