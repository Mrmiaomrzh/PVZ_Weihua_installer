name: Build PVZ Weihua Pre-release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'åŸºç¤Žç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: 0.0.1)'
        required: true
        default: '0.0.1'
      include_tools:
        description: 'æ˜¯å¦ä¸€åŒæ‰“åŒ…éŠæˆ²è£œä¸åŠå·¥å…· (src/Tools)?'
        required: true
        type: boolean
        default: true
      pre_install_text:
        description: 'å®‰è£å‰æ–‡æœ¬ (æ›´æ–°æ—¥èªŒ)'
        required: false
        type: string
      post_install_text:
        description: 'å®‰è£å¾Œæ–‡æœ¬ (æ³¨æ„äº‹é …)'
        required: false
        type: string

jobs:
  build-beta:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Assets and Script
        shell: powershell
        # ä½¿ç”¨ç’°å¢ƒè®Šé‡å‚³éžè¼¸å…¥ï¼Œå¾¹åº•æœçµ• PowerShell è§£æžæ³¨å…¥éŒ¯èª¤
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_INCLUDE_TOOLS: ${{ github.event.inputs.include_tools }}
          INPUT_PRE_TEXT: ${{ github.event.inputs.pre_install_text }}
          INPUT_POST_TEXT: ${{ github.event.inputs.post_install_text }}
        run: |
          # 1. ç”Ÿæˆæ™‚é–“æˆ³å’Œç‰ˆæœ¬è™Ÿ
          $buildTime = Get-Date -Format "yyyyMMddHHmm"
          $baseVer = $env:INPUT_VERSION
          $verRaw = "$baseVer-$buildTime"
          
          # æ¸…æ´—ç´”æ•¸å­—ç‰ˆæœ¬è™Ÿ (X.X.X.X) ä¾› VersionInfoVersion ä½¿ç”¨
          $digits = ($baseVer -split '[^0-9]+' | Where-Object { $_ -ne "" })
          $verBinary = "$($digits[0..2] -join '.').0"
          if ([string]::IsNullOrEmpty($verBinary) -or $verBinary -eq ".0") { $verBinary = "1.0.0.0" }

          Write-Host "Build Time: $buildTime"
          Write-Host "Display Version: $verRaw"
          Write-Host "Binary Version: $verBinary"

          # 2. ç›®éŒ„æº–å‚™
          if (!(Test-Path "Output")) { New-Item -ItemType Directory -Path "Output" | Out-Null }
          if (!(Test-Path "Setup")) { New-Item -ItemType Directory -Path "Setup" | Out-Null }

          # 3. åˆä½µå·¥å…·
          if ($env:INPUT_INCLUDE_TOOLS -eq 'true' -and (Test-Path "src/Tools")) {
              Write-Host "Merging tools..."
              Copy-Item -Path "src/Tools/*" -Destination "Game/" -Recurse -Force
          }

          # 4. è™•ç†å®‰è£æ–‡æœ¬
          $preContent = $env:INPUT_PRE_TEXT
          if ([string]::IsNullOrWhiteSpace($preContent)) {
              if (Test-Path "src/IPT/IBF.txt") {
                  $preContent = Get-Content "src/IPT/IBF.txt" -Raw
              } else {
                  $preContent = "PVZ Weihua Pre-release Build."
              }
          }
          $finalPreText = "[PRE-RELEASE] Build Time: $buildTime`r`n`r`n$preContent"
          # åœ¨ Windows PowerShell 5.1 ä¸­ï¼Œutf8 åƒæ•¸æœƒè‡ªå‹•ç”Ÿæˆå¸¶ BOM çš„æ–‡ä»¶
          $finalPreText | Out-File -FilePath "Setup/IBF.txt" -Encoding utf8 -Force

          $postContent = $env:INPUT_POST_TEXT
          if ([string]::IsNullOrWhiteSpace($postContent)) {
              if (Test-Path "src/IPT/IAF.txt") {
                  $iafContent = Get-Content "src/IPT/IAF.txt" -Raw
                  $iafContent | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8 -Force
              } else {
                  "Installation Complete." | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8 -Force
              }
          } else {
              $postContent | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8 -Force
          }

          # 5. ä¿®æ”¹ ISS è…³æœ¬ä¸¦å¼·åˆ¶ä¿®æ­£è·¯å¾‘
          $issSource = "src/Main.iss"
          $issTarget = "Setup/PVZ_Weihua_Beta.iss"
          Copy-Item $issSource -Destination $issTarget -Force
          
          $content = Get-Content $issTarget -Raw -Encoding utf8
          
          # æ›¿æ›ç‰ˆæœ¬è™Ÿ
          $content = $content -replace '(#define\s+MyAppVerNum\s+)"[^"]*"', "`$1""$verRaw"""
          $content = $content -replace '(#define\s+MyAppVerFull\s+)"[^"]*"', "`$1""$verBinary"""
          
          # å¼·åˆ¶ä¿®æ­£æ‰€æœ‰å¼•ç”¨è·¯å¾‘ï¼Œç¢ºä¿ç·¨è­¯å™¨èƒ½æ‰¾åˆ°æ–‡ä»¶
          $content = $content -replace 'InfoBeforeFile=.*', 'InfoBeforeFile=IBF.txt'
          $content = $content -replace 'InfoAfterFile=.*', 'InfoAfterFile=IAF.txt'
          $content = $content -replace 'LicenseFile=.*', 'LicenseFile=..\src\IPT\LF.txt'
          $content = $content -replace 'MessagesFile=.*', 'MessagesFile=ChineseSimplified.isl'
          $content = $content -replace 'SetupIconFile=.*', 'SetupIconFile=ico.ico'
          
          # ä¿®æ­£éŠæˆ²æ–‡ä»¶æºè·¯å¾‘
          $content = $content -replace 'Source:\s*".*\\{#MyAppExeName}";', 'Source: "..\Game\{#MyAppExeName}";'
          $content = $content -replace 'Source:\s*".*\\\*";', 'Source: "..\Game\*";'
          
          # ä»¥ UTF-8 (ç„¡BOM) ä¿å­˜ ISS æ–‡ä»¶
          [System.IO.File]::WriteAllText((Get-Item $issTarget).FullName, $content, (New-Object System.Text.UTF8Encoding($False)))
          
          # è¼¸å‡ºç’°å¢ƒè®Šé‡ä¾›å¾ŒçºŒ Release æ­¥é©Ÿä½¿ç”¨
          echo "FINAL_VER=$verRaw" >> $env:GITHUB_ENV

      - name: Compile Beta Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: Setup/PVZ_Weihua_Beta.iss

      - name: Create Beta Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.FINAL_VER }}
          name: PVZ Weihua ${{ env.FINAL_VER }} (BETA)
          body: |
            ### ðŸ§ª è‡ªå‹•ç·¨è­¯æ¸¬è©¦ç‰ˆ
            - **ç·¨è­¯ç‰ˆæœ¬**: ${{ env.FINAL_VER }}
            - **æ›´æ–°èªªæ˜Ž**: 
            ${{ github.event.inputs.pre_install_text || 'ç„¡è©³ç´°èªªæ˜Ž' }}
          files: |
            Output/*.exe
          prerelease: true
          overwrite_files: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}