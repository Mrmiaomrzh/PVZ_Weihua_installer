name: Build PVZ Weihua Pre-release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'åŸºç¤Žç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: 0.0.1)'
        required: true
        default: '1.0.0'
      include_tools:
        description: 'æ˜¯å¦ä¸€åŒæ‰“åŒ…éŠæˆ²è£œä¸åŠå·¥å…· (src/Tools)?'
        required: true
        type: boolean
        default: true
      pre_install_text:
        description: 'å®‰è£å‰æ–‡æœ¬ (æ›´æ–°æ—¥èªŒ)'
        required: false
        type: string
      post_install_text:
        description: 'å®‰è£å¾Œæ–‡æœ¬ (æ³¨æ„äº‹é …)'
        required: false
        type: string

jobs:
  build-beta:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Assets and Script
        shell: powershell
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_INCLUDE_TOOLS: ${{ github.event.inputs.include_tools }}
          INPUT_PRE_TEXT: ${{ github.event.inputs.pre_install_text }}
          INPUT_POST_TEXT: ${{ github.event.inputs.post_install_text }}
        run: |
          # 1. ç”Ÿæˆæ™‚é–“æˆ³
          $buildTime = Get-Date -Format "yyyyMMddHHmm"
        
          # 2. ç”Ÿæˆé¡¯ç¤ºç‰ˆæœ¬è™Ÿ (X.X.X.X-YYYYMMDDHHMM)
          $verRaw = "$($env:INPUT_VERSION)-$buildTime"
          
          # 3. ç”ŸæˆäºŒé€²åˆ¶ç‰ˆæœ¬è™Ÿ
          $cleanVer = ($env:INPUT_VERSION -split '[^0-9]+' | Where-Object { $_ -ne "" })[0..2]
          while ($cleanVer.Count -lt 3) { $cleanVer += "0" }
          $verBinary = "$($cleanVer -join ".").0"
          
          Write-Host "Display Version (with timestamp): $verRaw"
          Write-Host "Binary Version for Windows: $verBinary"

          # 4. æº–å‚™ç›®éŒ„èˆ‡å·¥å…·
          if (!(Test-Path "Output")) { New-Item -ItemType Directory -Path "Output" | Out-Null }
          if ($env:INPUT_INCLUDE_TOOLS -eq 'true' -and (Test-Path "src/Tools")) {
              Copy-Item -Path "src/Tools/*" -Destination "Game/" -Recurse -Force
          }

          # 5. è™•ç†å®‰è£æ–‡æœ¬
          if ([string]::IsNullOrWhiteSpace($env:INPUT_PRE_TEXT)) {
            $defaultPre = Get-Content "src/IPT/IBF.txt" -Raw
            "[PRE-RELEASE] ç·¨è­¯æ™‚é–“: $buildTime`n`n$defaultPre" | Out-File -FilePath "Setup/IBF.txt" -Encoding utf8 -Force
          } else {
            $env:INPUT_PRE_TEXT | Out-File -FilePath "Setup/IBF.txt" -Encoding utf8 -Force
          }
          if ([string]::IsNullOrWhiteSpace($env:INPUT_POST_TEXT)) {
            Copy-Item "src/IPT/IAF.txt" -Destination "Setup/IAF.txt" -Force
          } else {
            $env:INPUT_POST_TEXT | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8 -Force
          }

          # 6. ä¿®æ”¹ ISS è…³æœ¬
          $issSource = "src/Main.iss"
          $issTarget = "Setup/PVZ_Weihua_Beta.iss"
          Copy-Item $issSource -Destination $issTarget -Force
          $content = Get-Content $issTarget -Raw -Encoding utf8
          $content = $content -replace '(#define\s+MyAppVerNum\s+)"[^"]*"', "`$1""$verRaw"""
          $content = $content -replace '(#define\s+MyAppVerFull\s+)"[^"]*"', "`$1""$verBinary"""
          $content = $content -replace 'InfoBeforeFile=.*', 'InfoBeforeFile=IBF.txt'
          $content = $content -replace 'InfoAfterFile=.*', 'InfoAfterFile=IAF.txt'
          $content = $content -replace 'LicenseFile=.*', 'LicenseFile=..\src\IPT\LF.txt'
          $content = $content -replace 'MessagesFile=.*', 'MessagesFile=ChineseSimplified.isl'
          $content = $content -replace 'SetupIconFile=.*', 'SetupIconFile=ico.ico'
          $content = $content -replace 'Source:\s*".*\\{#MyAppExeName}";', 'Source: "..\Game\{#MyAppExeName}";'
          $content = $content -replace 'Source:\s*".*\\\*";', 'Source: "..\Game\*";'
          
          [System.IO.File]::WriteAllText((Get-Item $issTarget).FullName, $content, (New-Object System.Text.UTF8Encoding($False)))
          

          echo "FINAL_VER=$verRaw" >> $env:GITHUB_ENV

      - name: Compile Beta Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: Setup/PVZ_Weihua_Beta.iss

      - name: Create Beta Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.FINAL_VER }}
          name: PVZ Weihua ${{ env.FINAL_VER }} (BETA)
          body: |
            ### ðŸ§ª è‡ªå‹•ç·¨è­¯æ¸¬è©¦ç‰ˆ
            - **åŸºç¤Žç‰ˆæœ¬**: ${{ github.event.inputs.version }}
            - **ç·¨è­¯æ¨™ç±¤**: ${{ env.FINAL_VER }}
            - **æ›´æ–°å…§å®¹**: 
            ${{ github.event.inputs.pre_install_text || 'ç„¡è©³ç´°èªªæ˜Ž' }}
          files: |
            Output/*.exe
          prerelease: true
          overwrite_files: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}