name: Build PVZ Weihua Pre-release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç™¼å¸ƒç‰ˆæœ¬è™Ÿ'
        required: true
        default: '1.0.0-beta'
      is_prerelease:
        description: 'æ˜¯å¦æ¨™è¨˜ç‚ºé ç™¼å¸ƒç‰ˆæœ¬ï¼Ÿ'
        required: true
        type: boolean
        default: true
      include_tools:
        description: 'æ˜¯å¦ä¸€åŒæ‰“åŒ…éŠæˆ²è£œä¸åŠå·¥å…· (src/Tools)?'
        required: true
        type: boolean
        default: true
      pre_install_text:
        description: 'é ç™¼å¸ƒç‰ˆæ›´æ–°æ—¥èªŒ (å®‰è£å‰æ–‡æœ¬)'
        required: false
        type: string
      post_install_text:
        description: 'æ¸¬è©¦æ³¨æ„äº‹é … (å®‰è£å¾Œæ–‡æœ¬)'
        required: false
        type: string

jobs:
  build-beta:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Assets and Script
        shell: powershell
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_INCLUDE_TOOLS: ${{ github.event.inputs.include_tools }}
          INPUT_PRE_TEXT: ${{ github.event.inputs.pre_install_text }}
          INPUT_POST_TEXT: ${{ github.event.inputs.post_install_text }}
        run: |
          $ver = $env:INPUT_VERSION
          
          if (!(Test-Path "Output")) { New-Item -ItemType Directory -Path "Output" }

          if ($env:INPUT_INCLUDE_TOOLS -eq 'true') {
            Write-Host "Merging tools for beta testing..."
            if (Test-Path "src/Tools") {
              Copy-Item -Path "src/Tools/*" -Destination "Game/" -Recurse -Force
            }
          }


          # å¦‚æœç”¨æˆ¶æ²’è¼¸å…¥ï¼Œå‰‡åœ¨é»˜èªæ–‡æœ¬å‰åŠ ä¸Š [æ¸¬è©¦ç‰ˆ] å­—æ¨£
          if ([string]::IsNullOrWhiteSpace($env:INPUT_PRE_TEXT)) {
            $defaultPre = Get-Content "src/IPT/IBF.txt" -Raw
            "[PRE-RELEASE / BETA] æ­¤ç‰ˆæœ¬ç‚ºæ¸¬è©¦ç‰ˆæœ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸ç©©å®šå› ç´ ã€‚`n`n$defaultPre" | Out-File -FilePath "Setup/IBF.txt" -Encoding utf8 -Force
          } else {
            $env:INPUT_PRE_TEXT | Out-File -FilePath "Setup/IBF.txt" -Encoding utf8 -Force
          }

          if ([string]::IsNullOrWhiteSpace($env:INPUT_POST_TEXT)) {
            Copy-Item "src/IPT/IAF.txt" -Destination "Setup/IAF.txt" -Force
          } else {
            $env:INPUT_POST_TEXT | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8 -Force
          }

          $issSource = "src/Main.iss"
          $issTarget = "Setup/PVZ_Weihua_Beta.iss"
          Copy-Item $issSource -Destination $issTarget -Force

          $content = Get-Content $issTarget -Raw -Encoding utf8
          
          # æ›¿æ›ç‰ˆæœ¬è™Ÿ (æ”¯æŒå¸¶å¾Œç¶´çš„ç‰ˆæœ¬è™Ÿ)
          $content = $content -replace '(#define\s+MyAppVerNum\s+)"[^"]*"', "`$1""$ver"""
          $content = $content -replace '(#define\s+MyAppVerFull\s+)"[^"]*"', "`$1""$ver"""
          
          $content = $content -replace 'InfoBeforeFile=.*', 'InfoBeforeFile=IBF.txt'
          $content = $content -replace 'InfoAfterFile=.*', 'InfoAfterFile=IAF.txt'
          $content = $content -replace 'MessagesFile=.*', 'MessagesFile=ChineseSimplified.isl'
          $content = $content -replace 'SetupIconFile=.*', 'SetupIconFile=ico.ico'
          $content = $content -replace 'Source:\s*".*\\{#MyAppExeName}";', 'Source: "..\Game\{#MyAppExeName}";'
          $content = $content -replace 'Source:\s*".*\\\*";', 'Source: "..\Game\*";'
          
          $Utf8NoBom = New-Object System.Text.UTF8Encoding($False)
          [System.IO.File]::WriteAllText((Get-Item $issTarget).FullName, $content, $Utf8NoBom)

      - name: Compile Beta Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: Setup/PVZ_Weihua_Beta.iss

      - name: Create Beta Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: PVZ Weihua ${{ github.event.inputs.version }} (Pre-release)
          body: |
            ### ğŸ§ª é ç™¼å¸ƒç‰ˆæ¸¬è©¦èªªæ˜
            ${{ github.event.inputs.pre_install_text || 'æ­¤ç‰ˆæœ¬ç‚ºè‡ªå‹•æ§‹å»ºçš„é ç™¼å¸ƒç‰ˆï¼Œåƒ…ä¾›æ¸¬è©¦ä½¿ç”¨ã€‚' }}
          files: |
            Output/*.exe
          prerelease: ${{ github.event.inputs.is_prerelease }}
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}