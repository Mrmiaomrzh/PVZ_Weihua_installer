name: Build PVZ Weihua Installer

on:
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号 (例如: 1.0.5)'
        required: true
        default: '1.0.0'
      include_tools:
        description: '是否一同打包游戏补丁及工具 (src/Tools)?'
        required: true
        type: boolean
        default: false
      pre_install_text:
        description: '安装前显示文本 (留空则默认复制 src/IPT/IBF.txt)'
        required: false
        type: string
      post_install_text:
        description: '安装后显示文本 (留空则默认复制 src/IPT/IAF.txt)'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Assets and Script
        shell: powershell
        # 使用环境变量处理输入，防止特殊字符（如 []）破坏 PowerShell 语法
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_INCLUDE_TOOLS: ${{ github.event.inputs.include_tools }}
          INPUT_PRE_TEXT: ${{ github.event.inputs.pre_install_text }}
          INPUT_POST_TEXT: ${{ github.event.inputs.post_install_text }}
        run: |
          $ver = $env:INPUT_VERSION
          
          # 1. 确保 Output 目录存在 (Main.iss 中定义了 OutputDir=..\Output)
          if (!(Test-Path "Output")) { New-Item -ItemType Directory -Path "Output" | Out-Null }

          # 2. 处理工具包打包逻辑
          if ($env:INPUT_INCLUDE_TOOLS -eq 'true') {
            Write-Host "Merging tools from src/Tools to Game directory..."
            if (Test-Path "src/Tools") {
              Copy-Item -Path "src/Tools/*" -Destination "Game/" -Recurse -Force
            }
          }

          # 3. 处理安装前文本 (IBF.txt)
          if ([string]::IsNullOrWhiteSpace($env:INPUT_PRE_TEXT)) {
            Write-Host "Using default IBF.txt"
            Copy-Item "src/IPT/IBF.txt" -Destination "Setup/IBF.txt" -Force
          } else {
            $env:INPUT_PRE_TEXT | Out-File -FilePath "Setup/IBF.txt" -Encoding utf8 -Force
          }

          # 4. 处理安装后文本 (IAF.txt)
          if ([string]::IsNullOrWhiteSpace($env:INPUT_POST_TEXT)) {
            Write-Host "Using default IAF.txt"
            Copy-Item "src/IPT/IAF.txt" -Destination "Setup/IAF.txt" -Force
          } else {
            $env:INPUT_POST_TEXT | Out-File -FilePath "Setup/IAF.txt" -Encoding utf8 -Force
          }

          # 5. 修改并重命名 ISS 脚本
          $issSource = "src/Main.iss"
          $issTarget = "Setup/PVZ_Weihua.iss"
          Write-Host "Modifying $issSource to $issTarget"
          Copy-Item $issSource -Destination $issTarget -Force

          $content = Get-Content $issTarget -Raw -Encoding utf8
          # 替换版本号变量
          $content = $content -replace '(#define MyAppVerNum\s+)"[^"]*"', "`$1""$ver"""
          $content = $content -replace '(#define MyAppVerFull\s+)"[^"]*"', "`$1""$ver"""
          
          # 以 UTF-8 (无BOM) 格式写入，确保 Inno Setup 兼容
          $Utf8NoBom = New-Object System.Text.UTF8Encoding($False)
          [System.IO.File]::WriteAllText((Get-Item $issTarget).FullName, $content, $Utf8NoBom)
          
      - name: Compile Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
        with:
          path: Setup/PVZ_Weihua.iss

      - name: Capture Release Notes
        id: notes
        shell: powershell
        run: |
          # 读取最终生成的 IBF.txt 作为 Release 介绍
          $text = Get-Content "Setup/IBF.txt" -Raw -Encoding utf8
          "RELEASENOTES<<EOF" >> $env:GITHUB_OUTPUT
          $text >> $env:GITHUB_OUTPUT
          "EOF" >> $env:GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: PVZ Weihua v${{ github.event.inputs.version }}
          body: ${{ steps.notes.outputs.RELEASENOTES }}
          files: |
            Output/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
